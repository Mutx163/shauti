version: 2.1

jobs:
  build-android:
    docker:
      - image: cimg/android:2024.01.1-node
    environment:
      JAVA_OPTS: "-Xmx4g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs=-Xmx4g"
    resource_class: large
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: npm install
      
      - run:
          name: Install CMake and Ninja
          command: |
            # Method 1: Try pip (fastest & cleanest)
            if command -v pip3 &> /dev/null; then
              echo "Installing via pip..."
              sudo pip3 install cmake ninja && success=1
            fi

            # Method 2: Direct Download if pip failed (Avoids apt GPG/Network issues)
            if [ -z "$success" ]; then
              echo "Pip failed. Downloading Ninja binary directly..."
              wget -q https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-linux.zip
              unzip -q ninja-linux.zip
              sudo mv ninja /usr/local/bin/
              sudo chmod +x /usr/local/bin/ninja
            fi
            
            echo "Installing Android SDK components..."
            mkdir -p ~/.android && touch ~/.android/repositories.cfg
            # Fix: Handle SIGPIPE (exit 141) from 'yes' when sdkmanager closes stdin
            (yes || true) | sdkmanager "cmake;3.22.1" "ndk;25.1.8937393"

      - run:
          name: Expo Prebuild
          command: npx expo prebuild --platform android --no-install

      - run:
          name: Build Debug APK
          command: |
            cd android
            chmod +x gradlew
            ./gradlew assembleDebug

      - store_artifacts:
          path: android/app/build/outputs/apk/debug/app-debug.apk
          destination: app-debug.apk

workflows:
  build-flow:
    jobs:
      - build-android
